# Status code to reason phrase mapping
map $status $status_phrase {
    200 "OK";
    201 "Created";
    202 "Accepted";
    204 "No Content";
    301 "Moved Permanently";
    302 "Found";
    304 "Not Modified";
    400 "Bad Request";
    401 "Unauthorized";
    403 "Forbidden";
    404 "Not Found";
    405 "Method Not Allowed";
    408 "Request Timeout";
    409 "Conflict";
    410 "Gone";
    413 "Payload Too Large";
    415 "Unsupported Media Type";
    429 "Too Many Requests";
    500 "Internal Server Error";
    501 "Not Implemented";
    502 "Bad Gateway";
    503 "Service Unavailable";
    504 "Gateway Timeout";
    default "Unknown";
}

# Status code to log level mapping
map $status $level_name {
    ~^2 "INFO";
    ~^3 "WARNING";
    ~^4 "ERROR";
    ~^5 "CRITICAL";
    default "INFO";
}

# JSON log format for access logs
log_format json_combined escape=json
    '{'
        '"time":"$time_iso8601",'
        '"remote_addr":"$remote_addr",'
        '"remote_user":"$remote_user",'
        '"host":"$host",'
        '"scheme":"$scheme",'
        '"server_name":"$server_name",'
        '"message":"$request",'
        '"status":"$status_phrase",'
        '"level":"$status",'
        '"level_name":"$level_name",'
        '"request_method":"$request_method",'
        '"request_uri":"$request_uri",'
        '"body_bytes_sent":"$body_bytes_sent",'
        '"bytes_sent":"$bytes_sent",'
        '"request_length":"$request_length",'
        '"request_time":"$request_time",'
        '"upstream_response_time":"$upstream_response_time",'
        '"upstream_connect_time":"$upstream_connect_time",'
        '"upstream_header_time":"$upstream_header_time",'
        '"connection":"$connection",'
        '"connection_requests":"$connection_requests",'
        '"http_referer":"$http_referer",'
        '"http_user_agent":"$http_user_agent",'
        '"http_x_forwarded_for":"$http_x_forwarded_for",'
        '"http_x_forwarded_host":"$http_x_forwarded_host",'
        '"http_x_forwarded_proto":"$http_x_forwarded_proto",'
        '"http_x_real_ip":"$http_x_real_ip",'
        '"event_type":"access"'
    '}';

# JSON log format for security/blocked requests
log_format security_log escape=json
    '{'
        '"time":"$time_iso8601",'
        '"remote_addr":"$remote_addr",'
        '"host":"$host",'
        '"message":"$request",'
        '"status":"$status_phrase",'
        '"level":"$status",'
        '"level_name":"$level_name",'
        '"http_user_agent":"$http_user_agent",'
        '"http_x_forwarded_for":"$http_x_forwarded_for",'
        '"http_x_forwarded_host":"$http_x_forwarded_host",'
        '"event_type":"security_block"'
    '}';

# Skip logging by monitor/healthcheck user agents
map $http_user_agent $log_by_ua {
    # Kubernetes
    ~*kube-probe 0;
    ~*Kubernetes 0;

    # AWS
    ~*ELB-HealthChecker 0;
    ~*Amazon-Route53 0;
    ~*Amazon-Route53-Health-Check-Service 0;

    # GCP
    ~*GoogleHC 0;
    ~*Google-Cloud 0;
    ~*Google-Cloud-Load-Balancer 0;

    # Azure
    ~*Azure 0;
    ~*Microsoft-Azure-Application-Gateway 0;
    ~*Azure-Health-Probe 0;

    # Monitoring
    ~*Uptime-Kuma 0;
    ~*Pingdom 0;
    ~*StatusCake 0;
    ~*UptimeRobot 0;
    ~*Site24x7 0;
    ~*Datadog 0;
    ~*NewRelic 0;
    ~*Nagios 0;
    ~*Zabbix 0;
    ~*Cloudflare-Traffic-Manager 0;

    default 1;
}

# Skip logging on common health endpoints
map $request_uri $log_by_uri {
    ~*^/(health|up|ready|live|metrics)(/|$) 0;
    ~*^/\.well-known/acme-challenge(/|$) 0;
    default 1;
}

# Final access-log switch (disabled if either rule says no)
map "$log_by_ua:$log_by_uri" $loggable {
    default 1;
    "0:0" 0;
    "0:1" 0;
    "1:0" 0;
}
