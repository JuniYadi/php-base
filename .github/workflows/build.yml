# ===============================================
# Multi-Version PHP Base Image CI/CD
# ===============================================
# Builds: PHP 8.2, 8.3, 8.4, 8.5
# Base Images: Alpine (default) and Debian
# Platforms: Multi-arch (AMD64 + ARM64)
# ARM64 uses native ubuntu-24.04-arm runners for faster builds
#
# CI Strategy:
# - Pull Requests: Build only (no push), use cache for fast validation
# - Main Branch: Build AND push to registry, create manifest lists
# - Schedule: Weekly build with push (security updates)
# ===============================================

name: Multi-Version PHP Build

on:
  push:
    branches: [main]
    paths-ignore:
      - '**.md'
      - 'docs/**'
  pull_request:
    branches: [main]
  schedule:
    - cron: '0 0 * * 0'
  workflow_dispatch:
    inputs:
      push:
        description: 'Push images to registry (only works on main branch)'
        required: false
        type: boolean
        default: false
      php_version:
        description: 'PHP version to build (leave empty for all)'
        required: false
        type: string
        default: ''
      base_image:
        description: 'Base image (alpine or debian)'
        required: false
        type: string
        default: 'alpine'

env:
  REGISTRY: ghcr.io
  # Use lowercase for image names (GitHub Packages requires consistent casing)
  IMAGE_NAME: juniyadi/php-base

jobs:
  # -----------------------------------------------
  # Job: Build PHP Images (Matrix)
  # -----------------------------------------------
  build:
    name: Build PHP ${{ matrix.php_version }} (${{ matrix.base_image }}-${{ matrix.arch }})
    # Use native ARM64 runner for ARM builds, standard runner for AMD64
    runs-on: ${{ matrix.arch == 'arm64' && 'ubuntu-24.04-arm' || 'ubuntu-24.04' }}
    strategy:
      fail-fast: false
      matrix:
        php_version: ['8.2', '8.3', '8.4', '8.5']
        base_image: ['alpine', 'debian']
        arch: ['amd64', 'arm64']
        exclude:
          # Only build Debian for latest versions (8.4, 8.5)
          - php_version: '8.2'
            base_image: 'debian'
          - php_version: '8.3'
            base_image: 'debian'
        include:
          - php_version: '8.5'
            base_image: 'alpine'
            arch: 'amd64'
            is_latest: true
          - php_version: '8.5'
            base_image: 'alpine'
            arch: 'arm64'
            is_latest: true

    permissions:
      contents: read
      packages: write
      security-events: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GHCR_TOKEN }}

      - name: Extract metadata for tags
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            # Version-only tag (multi-arch, defaults to debian for 8.5)
            type=raw,value=${{ matrix.php_version }}
            # Version-base tag (multi-arch, e.g., 8.5-debian, 8.5-alpine)
            type=raw,value=${{ matrix.php_version }}-${{ matrix.base_image }}
            # Architecture-specific tags (explicit arch for specific pulls)
            type=raw,value=${{ matrix.php_version }}-${{ matrix.base_image }}-${{ matrix.arch }}
            type=sha,prefix=${{ matrix.php_version }}-${{ matrix.base_image }}-${{ matrix.arch }}-,format=long
            # Latest tag from 8.5-debian (both archs)
            ${{ matrix.php_version == '8.5' && matrix.base_image == 'debian' && 'type=raw,value=latest' || '' }}
          labels: |
            org.opencontainers.image.title=PHP ${{ matrix.php_version }} (${{ matrix.base_image }}-${{ matrix.arch }})
            org.opencontainers.image.description=Multi-version PHP runtime with ${{ matrix.base_image }} base
            php.version=${{ matrix.php_version }}
            base.image=${{ matrix.base_image }}
            os.arch=${{ matrix.arch }}

      - name: Build and push Docker image
        uses: docker/build-push-action@v6
        with:
          context: .
          # Only push on main branch push or manual dispatch with push=true
          # PRs and schedule builds will build without pushing (cache still works)
          push: ${{ (github.event_name == 'push' || inputs.push == true) && github.ref == 'refs/heads/main' }}
          # Build for the specific architecture (native ARM64 runner or AMD64)
          platforms: linux/${{ matrix.arch }}
          build-args: |
            PHP_VERSION=${{ matrix.php_version }}
            BASE_IMAGE=${{ matrix.base_image }}
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha,scope=php-${{ matrix.php_version }}-${{ matrix.base_image }}-${{ matrix.arch }}
          cache-to: type=gha,mode=max,scope=php-${{ matrix.php_version }}-${{ matrix.base_image }}-${{ matrix.arch }}
          provenance: false

  # -----------------------------------------------
  # Job: List All Image Sizes (from registry)
  # -----------------------------------------------
  # Only runs on main branch push when images are actually pushed to registry
  list-sizes:
    name: List Image Sizes
    runs-on: ubuntu-24.04
    needs: build
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GHCR_TOKEN }}

      - name: Get image sizes from registry
        run: |
          chmod +x check-image-sizes.sh
          ./check-image-sizes.sh

      - name: Update README with image sizes
        run: |
          # Generate size table (arch-specific only)
          {
            echo "| Version | Base | Arch | Size |"
            echo "|---------|------|------|------|"
            for img in 8.2-alpine-amd64 8.2-alpine-arm64 8.3-alpine-amd64 8.3-alpine-arm64 8.4-alpine-amd64 8.4-alpine-arm64 8.4-debian-amd64 8.4-debian-arm64 8.5-alpine-amd64 8.5-alpine-arm64 8.5-debian-amd64 8.5-debian-arm64; do
              version=$(echo "$img" | cut -d'-' -f1)
              base=$(echo "$img" | cut -d'-' -f2)
              arch=$(echo "$img" | cut -d'-' -f3)
              size_bytes=$(docker manifest inspect "${REGISTRY}/${IMAGE_NAME}:${img}" | jq -r '[.layers[]?.size] | add')
              size_formatted=$(echo "$size_bytes" | awk '{printf "%.1f MB", $1/1024/1024}')
              echo "| PHP ${version} | ${base} | ${arch} | ${size_formatted} |"
            done
          } > /tmp/size-table.md

          # Build complete README section
          {
            echo "## Image Sizes"
            echo ""
            echo "<!-- SIZE_TABLE_START -->"
            echo "<!-- This section is auto-updated by CI. Do not edit manually. -->"
            echo ""
            cat /tmp/size-table.md
            echo ""
            echo "<!-- SIZE_TABLE_END -->"
          } > /tmp/readme-section.md

          # Replace section in README.md
          awk '
            /<!-- SIZE_TABLE_START -->/ { in_section=1; print; while ((getline line < "/tmp/readme-section.md") > 0) print line; close("/tmp/readme-section.md"); next }
            /<!-- SIZE_TABLE_END -->/ { in_section=0; next }
            !in_section { print }
          ' README.md > /tmp/README-new.md && mv /tmp/README-new.md README.md

          # Show the update
          echo ""
          echo "README.md updated with image sizes:"
          sed -n '/<!-- SIZE_TABLE_START -->/,/<!-- SIZE_TABLE_END -->/p' README.md

      - name: Commit README changes
        run: |
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git config user.name "github-actions[bot]"
          git add README.md
          git commit -m "docs: update image sizes [skip ci]" || echo "No changes to commit"
          git push origin main || echo "No changes to push"

  # -----------------------------------------------
  # Job: Create Multi-Arch Manifest Lists
  # -----------------------------------------------
  # Only runs on main branch push (when images are actually pushed)
  # PRs skip this - manifests would be incomplete
  create-manifests:
    name: Create Manifest Lists
    runs-on: ubuntu-24.04
    needs: build
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    steps:
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GHCR_TOKEN }}

      - name: Create manifest lists
        run: |
          echo "Creating multi-arch manifest lists..."

          REGISTRY="${{ env.REGISTRY }}"
          IMAGE_NAME="${{ env.IMAGE_NAME }}"

          # Create manifest lists for each version/base combination
          for VERSION in 8.2 8.3 8.4 8.5; do
            for BASE in alpine debian; do
              # Skip Debian for older versions (8.2, 8.3)
              if [[ "$VERSION" == "8.2" || "$VERSION" == "8.3" ]] && [[ "$BASE" == "debian" ]]; then
                continue
              fi

              echo "Creating manifest for: ${VERSION}-${BASE}"

              # Create multi-arch manifest (combines AMD64 + ARM64)
              docker buildx imagetools create \
                --annotation "org.opencontainers.image.description=Multi-version PHP ${VERSION} runtime with ${BASE} base" \
                ${REGISTRY}/${IMAGE_NAME}:${VERSION}-${BASE}-amd64 \
                ${REGISTRY}/${IMAGE_NAME}:${VERSION}-${BASE}-arm64 \
                -t ${REGISTRY}/${IMAGE_NAME}:${VERSION}-${BASE}
            done
          done

          # Create version-only tag (defaults to 8.5-debian multi-arch)
          echo "Creating version-only tags..."
          docker buildx imagetools create \
            --annotation "org.opencontainers.image.description=Multi-version PHP 8.5 runtime with debian base" \
            ${REGISTRY}/${IMAGE_NAME}:8.5-debian-amd64 \
            ${REGISTRY}/${IMAGE_NAME}:8.5-debian-arm64 \
            -t ${REGISTRY}/${IMAGE_NAME}:8.5

          # Create latest tag from 8.5-debian (glibc compatibility)
          echo "Creating latest tag..."
          docker buildx imagetools create \
            --annotation "org.opencontainers.image.description=Multi-version PHP runtime with debian base" \
            ${REGISTRY}/${IMAGE_NAME}:8.5-debian-amd64 \
            ${REGISTRY}/${IMAGE_NAME}:8.5-debian-arm64 \
            -t ${REGISTRY}/${IMAGE_NAME}:latest

          echo "Manifest lists created successfully!"

      - name: Verify manifests
        run: |
          REGISTRY="${{ env.REGISTRY }}"
          IMAGE_NAME="${{ env.IMAGE_NAME }}"
          echo "Verifying multi-arch images..."
          for TAG in 8.5 8.5-alpine 8.5-debian 8.4-alpine 8.3-alpine 8.2-alpine latest; do
            MANIFEST=$(docker manifest inspect ${REGISTRY}/${IMAGE_NAME}:${TAG} 2>/dev/null)
            if [ -n "$MANIFEST" ]; then
              AMD64=$(echo "$MANIFEST" | grep -c '"architecture": "amd64"' || echo "0")
              ARM64=$(echo "$MANIFEST" | grep -c '"architecture": "arm64"' || echo "0")
              echo "✓ ${TAG}: ${AMD64} AMD64 + ${ARM64} ARM64"
            else
              echo "✗ ${TAG}: Not found"
            fi
          done

  # -----------------------------------------------
  # Job: Security Scan (8.5 Alpine + Debian)
  # -----------------------------------------------
  # Only runs on main branch push when images are pushed to registry
  security:
    name: Security Scan (8.5)
    runs-on: ubuntu-latest
    needs: create-manifests
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    permissions:
      security-events: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GHCR_TOKEN }}

      - name: Pull images
        run: |
          docker pull "${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:8.5-alpine"
          docker pull "${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:8.5-debian"

      - name: Run Trivy vulnerability scanner (Alpine)
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: '${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:8.5-alpine'
          format: 'sarif'
          output: 'trivy-alpine.sarif'
          severity: 'CRITICAL,HIGH'
          ignore-unfixed: true

      - name: Run Trivy vulnerability scanner (Debian)
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: '${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:8.5-debian'
          format: 'sarif'
          output: 'trivy-debian.sarif'
          severity: 'CRITICAL,HIGH'
          ignore-unfixed: true

      - name: Upload Trivy scan results (Alpine)
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: 'trivy-alpine.sarif'
          category: 'trivy/php-8.5-alpine'

      - name: Upload Trivy scan results (Debian)
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: 'trivy-debian.sarif'
          category: 'trivy/php-8.5-debian'
