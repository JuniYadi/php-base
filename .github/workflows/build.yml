# ===============================================
# Multi-Version PHP Base Image CI/CD
# ===============================================
# Builds: PHP 8.2, 8.3, 8.4, 8.5
# Base Images: Alpine (default) and Debian
# Platforms: AMD64 only (for GitHub Packages)
# ===============================================

name: Multi-Version PHP Build

on:
  push:
    branches: [main]
    paths-ignore:
      - '**.md'
      - 'docs/**'
  pull_request:
    branches: [main]
  schedule:
    - cron: '0 0 * * 0'
  workflow_dispatch:
    inputs:
      push:
        description: 'Push images to registry'
        required: false
        type: boolean
        default: false
      php_version:
        description: 'PHP version to build (leave empty for all)'
        required: false
        type: string
        default: ''
      base_image:
        description: 'Base image (alpine or debian)'
        required: false
        type: string
        default: 'alpine'

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  # -----------------------------------------------
  # Job: Build PHP Images (Matrix)
  # -----------------------------------------------
  build:
    name: Build PHP ${{ matrix.php_version }} (${{ matrix.base_image }})
    runs-on: ubuntu-24.04
    strategy:
      fail-fast: false
      matrix:
        php_version: ['8.2', '8.3', '8.4', '8.5']
        base_image: ['alpine', 'debian']
        exclude:
          # Only build Debian for latest versions (8.4, 8.5)
          - php_version: '8.2'
            base_image: 'debian'
          - php_version: '8.3'
            base_image: 'debian'
        include:
          - php_version: '8.5'
            base_image: 'alpine'
            is_latest: true

    permissions:
      contents: read
      packages: write
      security-events: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata for tags
        id: meta
        uses: docker/metadata-action@v5
        with:
          # Use lowercase for repository name
          images: ghcr.io/juniyadi/php-base
          tags: |
            type=raw,value=${{ matrix.php_version }}-${{ matrix.base_image }}
            type=raw,value=${{ matrix.php_version }}-${{ matrix.base_image }}-amd64
            type=sha,prefix=${{ matrix.php_version }}-${{ matrix.base_image }}-,format=long
            ${{ matrix.is_latest == true && matrix.base_image == 'alpine' && 'type=raw,value=latest' || '' }}
            ${{ matrix.is_latest == true && matrix.base_image == 'alpine' && 'type=raw,value=alpine' || '' }}
          labels: |
            org.opencontainers.image.title=PHP ${{ matrix.php_version }} (${{ matrix.base_image }})
            org.opencontainers.image.description=Multi-version PHP runtime with ${{ matrix.base_image }} base
            php.version=${{ matrix.php_version }}
            base.image=${{ matrix.base_image }}

      - name: Build and push Docker image
        uses: docker/build-push-action@v6
        with:
          context: .
          push: ${{ github.event_name == 'push' || inputs.push }}
          platforms: linux/amd64
          build-args: |
            PHP_VERSION=${{ matrix.php_version }}
            BASE_IMAGE=${{ matrix.base_image }}
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha,scope=php-${{ matrix.php_version }}-${{ matrix.base_image }}-amd64
          cache-to: type=gha,mode=max,scope=php-${{ matrix.php_version }}-${{ matrix.base_image }}-amd64
          provenance: false

      - name: Get image size
        id: image-size
        run: |
          # Use lowercase for repository name
          IMAGE="ghcr.io/juniyadi/php-base:${{ matrix.php_version }}-${{ matrix.base_image }}"
          SIZE=$(docker images "$IMAGE" --format "{{.Size}}")
          DIGEST=$(docker images "$IMAGE" --format "{{.Digest}}" | sed 's/sha256://' | cut -c1-12)
          # Save to JSON for list-sizes job
          echo "{\"version\":\"${{ matrix.php_version }}\",\"base\":\"${{ matrix.base_image }}\",\"size\":\"${SIZE}\",\"digest\":\"${DIGEST}\"}" >> /tmp/image-sizes.json

      - name: Upload image sizes
        uses: actions/upload-artifact@v4
        with:
          name: image-sizes-${{ matrix.php_version }}-${{ matrix.base_image }}
          path: /tmp/image-sizes.json
          retention-days: 1

  # -----------------------------------------------
  # Job: List All Image Sizes (from build artifacts)
  # -----------------------------------------------
  list-sizes:
    name: List Image Sizes
    runs-on: ubuntu-24.04
    needs: build

    steps:
      - name: Download image size artifacts via API
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          # Get all artifact IDs matching image-sizes-*
          for art in $(gh api repos/${{ github.repository }}/actions/runs/${{ github.run_id }}/artifacts --paginate | jq -r '.artifacts[] | select(.name | startswith("image-sizes-")) | .id'); do
            echo "Downloading artifact $art"
            gh api repos/${{ github.repository }}/actions/artifacts/$art/zip --header "Accept: application/zip" -o /tmp/sizes-$art.zip 2>/dev/null
            unzip -q /tmp/sizes-$art.zip -d /tmp/sizes/ 2>/dev/null
            rm -f /tmp/sizes-$art.zip
          done

          # Combine all JSON files
          find /tmp/sizes -name '*.json' -exec cat {} \; > /tmp/image-sizes.json
          echo "Found $(wc -l < /tmp/image-sizes.json) image sizes"

      - name: Combine and display sizes
        run: |
          echo "========================================"
          echo "Docker Image Sizes for GitHub Packages"
          echo "========================================"
          echo ""
          echo "| Version | Base | Size | Digest |"
          echo "|---------|------|------|--------|"

          # Sort and display image sizes
          sort -t'"' -k3V /tmp/image-sizes.json | while IFS= read -r line; do
            VERSION=$(echo "$line" | grep -o '"version":"[^"]*"' | cut -d'"' -f4)
            BASE=$(echo "$line" | grep -o '"base":"[^"]*"' | cut -d'"' -f4)
            SIZE=$(echo "$line" | grep -o '"size":"[^"]*"' | cut -d'"' -f4)
            DIGEST=$(echo "$line" | grep -o '"digest":"[^"]*"' | cut -d'"' -f4)
            echo "| PHP ${VERSION} | ${BASE} | ${SIZE} | \`${DIGEST}\` |"
          done

          TOTAL=$(wc -l < /tmp/image-sizes.json)
          echo ""
          echo "**Total Images:** ${TOTAL}"
          echo "**Platform:** linux/amd64"
          echo "========================================"

      - name: Create size summary
        run: |
          echo "## PHP Docker Image Sizes" > /tmp/size-summary.md
          echo "" >> /tmp/size-summary.md
          echo "Built on: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> /tmp/size-summary.md
          echo "" >> /tmp/size-summary.md
          echo "| Version | Base | Size | Digest |" >> /tmp/size-summary.md
          echo "|---------|------|------|--------|" >> /tmp/size-summary.md

          # Sort and display image sizes
          sort -t'"' -k3V /tmp/image-sizes.json | while IFS= read -r line; do
            VERSION=$(echo "$line" | grep -o '"version":"[^"]*"' | cut -d'"' -f4)
            BASE=$(echo "$line" | grep -o '"base":"[^"]*"' | cut -d'"' -f4)
            SIZE=$(echo "$line" | grep -o '"size":"[^"]*"' | cut -d'"' -f4)
            DIGEST=$(echo "$line" | grep -o '"digest":"[^"]*"' | cut -d'"' -f4)
            echo "| PHP ${VERSION} | ${BASE} | ${SIZE} | \`${DIGEST}\` |" >> /tmp/size-summary.md
          done

          TOTAL=$(wc -l < /tmp/image-sizes.json)
          echo "" >> /tmp/size-summary.md
          echo "**Total Images:** ${TOTAL}" >> /tmp/size-summary.md
          echo "**Platform:** linux/amd64" >> /tmp/size-summary.md

          cat /tmp/size-summary.md

  # -----------------------------------------------
  # Job: Security Scan (Latest Alpine)
  # -----------------------------------------------
  # Only runs on main branch push when images are pushed to registry
  security:
    name: Security Scan (8.5-alpine)
    runs-on: ubuntu-latest
    needs: build
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    permissions:
      security-events: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Pull and scan image
        run: |
          # Use lowercase for repository name
          IMAGE_LOWER=$(echo "${{ env.REGISTRY }}/${{ github.repository }}" | tr '[:upper:]' '[:lower:]')
          docker pull "${IMAGE_LOWER}:8.5-alpine"

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          # Use lowercase for repository name
          image-ref: 'ghcr.io/juniyadi/php-base:8.5-alpine'
          format: 'sarif'
          output: 'trivy-result.sarif'
          severity: 'CRITICAL,HIGH'
          ignore-unfixed: true

      - name: Upload Trivy scan results
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: 'trivy-result.sarif'
          category: 'trivy/php-8.5-alpine'
