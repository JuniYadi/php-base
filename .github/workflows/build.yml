# ===============================================
# Multi-Version PHP Base Image CI/CD
# ===============================================
# Builds: PHP 8.2, 8.3, 8.4, 8.5
# Base Images: Alpine (default) and Debian
# Platforms: Multi-arch (AMD64 + ARM64)
# ARM64 uses native ubuntu-24.04-arm runners for faster builds
#
# CI Strategy:
# - Pull Requests: Build only (no push), use cache for fast validation
# - Main Branch: Build AND push to registry, create manifest lists
# - Schedule: Weekly build with push (security updates)
# ===============================================

name: Multi-Version PHP Build

on:
  push:
    branches: [main]
    paths-ignore:
      - '**.md'
      - 'docs/**'
  pull_request:
    branches: [main]
  schedule:
    - cron: '0 0 * * 0'
  workflow_dispatch:
    inputs:
      push:
        description: 'Push images to registry (only works on main branch)'
        required: false
        type: boolean
        default: false
      php_version:
        description: 'PHP version to build (leave empty for all)'
        required: false
        type: string
        default: ''
      base_image:
        description: 'Base image (alpine or debian)'
        required: false
        type: string
        default: 'alpine'

env:
  REGISTRY: ghcr.io
  # Use lowercase for image names (GitHub Packages requires consistent casing)
  IMAGE_NAME: juniyadi/php-base

jobs:
  # -----------------------------------------------
  # Job: Build PHP Images (Matrix)
  # -----------------------------------------------
  build:
    name: Build PHP ${{ matrix.php_version }} (${{ matrix.base_image }}-${{ matrix.arch }})
    # Use native ARM64 runner for ARM builds, standard runner for AMD64
    runs-on: ${{ matrix.arch == 'arm64' && 'ubuntu-24.04-arm' || 'ubuntu-24.04' }}
    strategy:
      fail-fast: false
      matrix:
        php_version: ['8.2', '8.3', '8.4', '8.5']
        base_image: ['alpine', 'debian']
        arch: ['amd64', 'arm64']
        exclude:
          # Only build Debian for latest versions (8.4, 8.5)
          - php_version: '8.2'
            base_image: 'debian'
          - php_version: '8.3'
            base_image: 'debian'
        include:
          - php_version: '8.5'
            base_image: 'alpine'
            arch: 'amd64'
            is_latest: true
          - php_version: '8.5'
            base_image: 'alpine'
            arch: 'arm64'
            is_latest: true

    permissions:
      contents: read
      packages: write
      security-events: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata for tags
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            # Architecture-specific tag (will be combined into multi-arch manifest)
            type=raw,value=${{ matrix.php_version }}-${{ matrix.base_image }}-${{ matrix.arch }}
            type=sha,prefix=${{ matrix.php_version }}-${{ matrix.base_image }}-${{ matrix.arch }}-,format=long
            # Latest/alpine tags only from PHP 8.5 Alpine (both archs will point to these)
            ${{ matrix.is_latest == true && matrix.base_image == 'alpine' && 'type=raw,value=latest' || '' }}
            ${{ matrix.is_latest == true && matrix.base_image == 'alpine' && 'type=raw,value=alpine' || '' }}
          labels: |
            org.opencontainers.image.title=PHP ${{ matrix.php_version }} (${{ matrix.base_image }}-${{ matrix.arch }})
            org.opencontainers.image.description=Multi-version PHP runtime with ${{ matrix.base_image }} base
            php.version=${{ matrix.php_version }}
            base.image=${{ matrix.base_image }}
            os.arch=${{ matrix.arch }}

      - name: Build and push Docker image
        uses: docker/build-push-action@v6
        with:
          context: .
          # Only push on main branch push or manual dispatch with push=true
          # PRs and schedule builds will build without pushing (cache still works)
          push: ${{ (github.event_name == 'push' || inputs.push == true) && github.ref == 'refs/heads/main' }}
          # Build for the specific architecture (native ARM64 runner or AMD64)
          platforms: linux/${{ matrix.arch }}
          build-args: |
            PHP_VERSION=${{ matrix.php_version }}
            BASE_IMAGE=${{ matrix.base_image }}
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha,scope=php-${{ matrix.php_version }}-${{ matrix.base_image }}-${{ matrix.arch }}
          cache-to: type=gha,mode=max,scope=php-${{ matrix.php_version }}-${{ matrix.base_image }}-${{ matrix.arch }}
          provenance: false

      - name: Get image size
        id: image-size
        run: |
          IMAGE="${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ matrix.php_version }}-${{ matrix.base_image }}-${{ matrix.arch }}"
          SIZE=$(docker images "$IMAGE" --format "{{.Size}}")
          DIGEST=$(docker images "$IMAGE" --format "{{.Digest}}" | sed 's/sha256://' | cut -c1-12)
          # Save to JSON for list-sizes job (include architecture)
          echo "{\"version\":\"${{ matrix.php_version }}\",\"base\":\"${{ matrix.base_image }}\",\"arch\":\"${{ matrix.arch }}\",\"size\":\"${SIZE}\",\"digest\":\"${DIGEST}\"}" >> /tmp/image-sizes.json

      - name: Upload image sizes
        uses: actions/upload-artifact@v4
        with:
          # Include architecture to avoid conflicts between AMD64 and ARM64 builds
          name: image-sizes-${{ matrix.php_version }}-${{ matrix.base_image }}-${{ matrix.arch }}
          path: /tmp/image-sizes.json
          retention-days: 1

  # -----------------------------------------------
  # Job: List All Image Sizes (from build artifacts)
  # -----------------------------------------------
  list-sizes:
    name: List Image Sizes
    runs-on: ubuntu-24.04
    needs: build

    steps:
      - name: Download all image size artifacts
        uses: actions/download-artifact@v4
        with:
          path: /tmp/sizes
          pattern: image-sizes-*
          merge-multiple: true

      - name: Combine and display sizes
        run: |
          echo "========================================"
          echo "Docker Image Sizes for GitHub Packages"
          echo "========================================"
          echo ""
          echo "Debug: Checking /tmp/sizes directory..."
          ls -la /tmp/sizes/ 2>/dev/null || echo "Directory empty or not found"
          echo ""
          echo "| Version | Base | Arch | Size | Digest |"
          echo "|---------|------|------|------|--------|"

          # Process each JSON file (find recursively)
          for file in $(find /tmp/sizes -name "*.json" 2>/dev/null); do
            if [ -f "$file" ]; then
              echo "Debug: Processing $file"
              cat "$file" 2>/dev/null || echo "Cannot read file"
              echo ""
              VERSION=$(jq -r '.version' "$file")
              BASE=$(jq -r '.base' "$file")
              ARCH=$(jq -r '.arch' "$file")
              SIZE=$(jq -r '.size' "$file")
              DIGEST=$(jq -r '.digest' "$file")
              echo "| PHP ${VERSION} | ${BASE} | ${ARCH} | ${SIZE} | \`${DIGEST}\` |"
            fi
          done

          TOTAL=$(ls -1 /tmp/sizes/*.json 2>/dev/null | wc -l)
          echo ""
          echo "**Total Images:** ${TOTAL}"
          echo "**Platforms:** linux/amd64, linux/arm64 (multi-arch)"
          echo "========================================"

      - name: Create size summary
        run: |
          echo "## PHP Docker Image Sizes" > /tmp/size-summary.md
          echo "" >> /tmp/size-summary.md
          echo "Built on: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> /tmp/size-summary.md
          echo "" >> /tmp/size-summary.md
          echo "| Version | Base | Arch | Size | Digest |" >> /tmp/size-summary.md
          echo "|---------|------|------|------|--------|" >> /tmp/size-summary.md

          # Process each JSON file
          for file in /tmp/sizes/*.json; do
            if [ -f "$file" ]; then
              VERSION=$(jq -r '.version' "$file")
              BASE=$(jq -r '.base' "$file")
              ARCH=$(jq -r '.arch' "$file")
              SIZE=$(jq -r '.size' "$file")
              DIGEST=$(jq -r '.digest' "$file")
              echo "| PHP ${VERSION} | ${BASE} | ${ARCH} | ${SIZE} | \`${DIGEST}\` |" >> /tmp/size-summary.md
            fi
          done

          TOTAL=$(ls -1 /tmp/sizes/*.json 2>/dev/null | wc -l)
          echo "" >> /tmp/size-summary.md
          echo "**Total Images:** ${TOTAL}" >> /tmp/size-summary.md
          echo "**Platforms:** linux/amd64, linux/arm64 (multi-arch)" >> /tmp/size-summary.md

          cat /tmp/size-summary.md

  # -----------------------------------------------
  # Job: Create Multi-Arch Manifest Lists
  # -----------------------------------------------
  # Only runs on main branch push (when images are actually pushed)
  # PRs skip this - manifests would be incomplete
  create-manifests:
    name: Create Manifest Lists
    runs-on: ubuntu-24.04
    needs: build
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    steps:
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Create manifest lists
        run: |
          echo "Creating multi-arch manifest lists..."

          # Define all version/base combinations
          VERSIONS=("8.2" "8.3" "8.4" "8.5")
          BASES=("alpine" "debian")
          REGISTRY="${{ env.REGISTRY }}"
          IMAGE_NAME="${{ env.IMAGE_NAME }}"

          for VERSION in "${VERSIONS[@]}"; do
            for BASE in "${BASES[@]}"; do
              # Skip Debian for older versions (8.2, 8.3)
              if [[ "$VERSION" == "8.2" || "$VERSION" == "8.3" ]] && [[ "$BASE" == "debian" ]]; then
                continue
              fi

              echo "Creating manifest for: ${VERSION}-${BASE}"

              # Create manifest list combining both architectures
              docker buildx imagetools create \
                ${REGISTRY}/${IMAGE_NAME}:${VERSION}-${BASE}-amd64 \
                ${REGISTRY}/${IMAGE_NAME}:${VERSION}-${BASE}-arm64 \
                -t ${REGISTRY}/${IMAGE_NAME}:${VERSION}-${BASE}
            done
          done

          # Create latest and alpine tags from 8.5-alpine
          echo "Creating latest/alpine tags..."
          docker buildx imagetools create \
            ${REGISTRY}/${IMAGE_NAME}:8.5-alpine-amd64 \
            ${REGISTRY}/${IMAGE_NAME}:8.5-alpine-arm64 \
            -t ${REGISTRY}/${IMAGE_NAME}:latest \
            -t ${REGISTRY}/${IMAGE_NAME}:alpine

          echo "Manifest lists created successfully!"

      - name: Verify manifests
        run: |
          REGISTRY="${{ env.REGISTRY }}"
          IMAGE_NAME="${{ env.IMAGE_NAME }}"
          echo "Verifying multi-arch images..."
          for TAG in 8.5-alpine 8.5-debian 8.4-alpine 8.3-alpine 8.2-alpine latest alpine; do
            MANIFEST=$(docker manifest inspect ${REGISTRY}/${IMAGE_NAME}:${TAG} 2>/dev/null)
            if [ -n "$MANIFEST" ]; then
              AMD64=$(echo "$MANIFEST" | grep -c '"architecture": "amd64"' || echo "0")
              ARM64=$(echo "$MANIFEST" | grep -c '"architecture": "arm64"' || echo "0")
              echo "✓ ${TAG}: ${AMD64} AMD64 + ${ARM64} ARM64"
            else
              echo "✗ ${TAG}: Not found"
            fi
          done

  # -----------------------------------------------
  # Job: Security Scan (Latest Alpine)
  # -----------------------------------------------
  # Only runs on main branch push when images are pushed to registry
  security:
    name: Security Scan (8.5-alpine)
    runs-on: ubuntu-latest
    needs: create-manifests
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    permissions:
      security-events: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Pull and scan image
        run: |
          # Use consistent image name from env
          IMAGE="${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:8.5-alpine"
          docker pull "${IMAGE}"
          # Note: No -amd64 suffix needed - manifest list pulls correct arch automatically

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: '${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:8.5-alpine'
          format: 'sarif'
          output: 'trivy-result.sarif'
          severity: 'CRITICAL,HIGH'
          ignore-unfixed: true

      - name: Upload Trivy scan results
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: 'trivy-result.sarif'
          category: 'trivy/php-8.5-alpine'
